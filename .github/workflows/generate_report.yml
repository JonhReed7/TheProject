name: Generate Readability Report

on:
  # –ó–∞–ø—É—Å–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é: –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –≤ 09:00 UTC
  schedule:
    - cron: '0 9 * * 1'
  
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
  workflow_dispatch:
    inputs:
      language:
        description: '–Ø–∑—ã–∫ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–æ–≤'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - en
          - ru
      deploy:
        description: '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–∞ GitHub Pages?'
        required: false
        default: true
        type: boolean

# –ü—Ä–∞–≤–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ (–Ω—É–∂–Ω–æ –¥–ª—è GitHub Pages)
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
      
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: üìä Generate analysis report
        run: |
          python scripts/generate_report.py \
            --output reports/index.md \
            --language ${{ github.event.inputs.language || 'auto' }}
      
      - name: üìù Convert Markdown to HTML
        run: |
          pip install markdown
          python -c "
          import markdown
          with open('reports/index.md', 'r') as f:
              md_content = f.read()
          html = markdown.markdown(md_content, extensions=['tables', 'fenced_code'])
          full_html = f'''<!DOCTYPE html>
          <html>
          <head>
              <meta charset=\"utf-8\">
              <title>Readability Analysis Report</title>
              <style>
                  body {{ font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; }}
                  table {{ border-collapse: collapse; width: 100%; margin: 20px 0; }}
                  th, td {{ border: 1px solid #ddd; padding: 12px; text-align: left; }}
                  th {{ background-color: #4CAF50; color: white; }}
                  tr:nth-child(even) {{ background-color: #f9f9f9; }}
                  h1, h2, h3 {{ color: #333; }}
                  code {{ background: #f4f4f4; padding: 2px 6px; border-radius: 4px; }}
              </style>
          </head>
          <body>{html}</body>
          </html>'''
          with open('reports/index.html', 'w') as f:
              f.write(full_html)
          "
      
      - name: üì¶ Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: readability-report-${{ github.run_number }}
          path: reports/
          retention-days: 30
      
      - name: üöÄ Deploy to GitHub Pages
        if: ${{ github.event.inputs.deploy != 'false' }}
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          destination_dir: .
          commit_message: 'üìä Update readability report'